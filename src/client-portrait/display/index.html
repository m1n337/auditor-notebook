
<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/default.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css"
    />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.2.0/diff.min.js"></script>
    <script type="text/javascript" src="./highlightjs-solidity/dist/solidity.min.js"></script>
  </head>

  <script>
  const titles = ["TectonicCoreT2:tectonicCoreVersion() → TectonicCoreT3:tectonicCoreVersion() → TectonicCoreT4:tectonicCoreVersion() → TectonicCoreT5:tectonicCoreVersion() → TectonicCoreT6:tectonicCoreVersion()","TectonicCoreT1:mintAllowed(address,address,uint) → TectonicCoreT5:mintAllowed(address,address,uint) → TectonicCoreT6:mintAllowed(address,address,uint)","TectonicCoreT1:claimTonic(address) → TectonicCoreT1:claimTonic(address) → TectonicCoreT5:claimTonic(address)","TectonicCoreT1:_setMintPaused(bool) → TectonicCoreT5:_setMintPaused(bool)","TectonicCoreT1:_setBorrowPaused(bool) → TectonicCoreT5:_setBorrowPaused(bool)","TectonicCoreT1:_setTransferPaused(bool) → TectonicCoreT5:_setTransferPaused(bool)","TectonicCoreT1:_setSeizePaused(bool) → TectonicCoreT5:_setSeizePaused(bool)","TectonicCoreT1:_become() → TectonicCoreT4:_become() → TectonicCoreT5:_become()","TectonicCoreT1:claimTonic(address[],bool,bool) → TectonicCoreT5:claimTonic(address[],bool,bool)","TectonicCoreT1:_grantTonic(address,uint) → TectonicCoreT5:_grantTonic(address,uint)","TectonicCoreT4:_upgradeSplitTonicRewards() → TectonicCoreT5:_upgradeSplitTonicRewards()","TectonicCoreT1:_supportMarket() → TectonicCoreT4:_supportMarket()","TectonicCoreT1:updateTonicSupplyIndex(address) → TectonicCoreT4:updateTonicSupplyIndex(address)","TectonicCoreT1:updateTonicBorrowIndex(address) → TectonicCoreT4:updateTonicBorrowIndex(address)","TectonicCoreT1:distributeSupplierTonic(address,address) → TectonicCoreT4:distributeSupplierTonic(address,address)","TectonicCoreT1:distributeBorrowerTonic(address,address) → TectonicCoreT4:distributeBorrowerTonic(address,address)","TectonicCoreT1:setTonicSpeedInternal(uint) → TectonicCoreT4:setTonicSpeedInternal(uint)","TectonicCoreT1:_setTonicSpeed(uint) → TectonicCoreT4:_setTonicSpeed(uint)","TectonicCoreT1:_setContributorTonicSpeed(address,uint) → TectonicCoreT4:_setContributorTonicSpeed(address,uint)","TectonicCoreT1:updateContributorRewards(address) → TectonicCoreT4:updateContributorRewards(address)","TectonicCoreT1:_setWhitelistProtect(bool) → TectonicCoreT3:_setWhitelistProtect(bool)","TectonicCoreT1:_addToWhitelistProtect(address[]) → TectonicCoreT3:_addToWhitelistProtect(address[])","TectonicCoreT1:_addToWhitelistProtectSingle(address) → TectonicCoreT3:_addToWhitelistProtectSingle(address)","TectonicCoreT1:_removeFromWhitelistProtect(address) → TectonicCoreT3:_removeFromWhitelistProtect(address)","TectonicCoreT1:_updateTvlProtectLimit(uint[]) → TectonicCoreT3:_updateTvlProtectLimit(uint[])","TectonicCoreT1:liquidateCalculateSeizeTokens(address,address,uint) → TectonicCoreT2:liquidateCalculateSeizeTokens(address,address,uint)"]
  const diffObjs = [["Index: \n===================================================================\n--- \tTectonicCoreT2:tectonicCoreVersion()/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT3:tectonicCoreVersion().sol\n@@ -1,4 +1,4 @@\n     function tectonicCoreVersion() external pure returns (uint8) {\n-        return 2;\n+        return 3;\n \n     }\n\\ No newline at end of file\n","Index: \n===================================================================\n--- \tTectonicCoreT3:tectonicCoreVersion()/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT4:tectonicCoreVersion().sol\n@@ -1,4 +1,4 @@\n     function tectonicCoreVersion() external pure returns (uint8) {\n-        return 3;\n+        return 4;\n \n     }\n\\ No newline at end of file\n","Index: \n===================================================================\n--- \tTectonicCoreT4:tectonicCoreVersion()/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT5:tectonicCoreVersion().sol\n@@ -1,4 +1,4 @@\n     function tectonicCoreVersion() external pure returns (uint8) {\n-        return 4;\n+        return 5;\n \n     }\n\\ No newline at end of file\n","Index: \n===================================================================\n--- \tTectonicCoreT5:tectonicCoreVersion()/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT6:tectonicCoreVersion().sol\n@@ -1,4 +1,4 @@\n     function tectonicCoreVersion() external pure returns (uint8) {\n-        return 5;\n+        return 6;\n \n     }\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:mintAllowed(address,address,uint)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT5:mintAllowed(address,address,uint).sol\n@@ -21,9 +21,8 @@\n             uint afterMintedUsed = add_(currentUsed, mintAmount);\n             if (afterMintedUsed > tokenToPerUserTvlProtectLimit[tToken]) {\n                 return uint(Error.TVL_PROTECT_EXCEEDED);\n             }\n-            \n \n             // Not exceed. Update used tvl limit\n             utilizedTvlAmount[tToken][minter] = afterMintedUsed;\n         }\n@@ -31,8 +30,17 @@\n         if (!markets[tToken].isListed) {\n             return uint(Error.MARKET_NOT_LISTED);\n         }\n \n+        // check if exceed supply cap\n+        uint supplyCap = supplyCaps[tToken];\n+        // Supply cap of 0 means unlimited minting\n+        if (supplyCap != 0) {\n+            uint totalSupplies = TToken(tToken).totalSupply();\n+            uint nextTotalSupplies  = add_(totalSupplies, mintAmount);\n+            require(nextTotalSupplies < supplyCap, \"market supply cap reached\");\n+        }\n+\n         // Keep the flywheel moving\n         updateTonicSupplyIndex(tToken);\n         distributeSupplierTonic(tToken, minter);\n \n","Index: \n===================================================================\n--- \tTectonicCoreT5:mintAllowed(address,address,uint)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT6:mintAllowed(address,address,uint).sol\n@@ -31,18 +31,25 @@\n             return uint(Error.MARKET_NOT_LISTED);\n         }\n \n         // check if exceed supply cap\n-        uint supplyCap = supplyCaps[tToken];\n+        uint supplyCapInUnderlyingToken = supplyCaps[tToken];\n \n+\n         // Supply cap of 0 means unlimited minting\n-        if (supplyCap != 0) {\n+        if (supplyCapInUnderlyingToken != 0) {\n \n+            uint exchangeRateMantissa = TToken(tToken).exchangeRateStored();\n             uint totalSupplies = TToken(tToken).totalSupply();\n-            uint nextTotalSupplies  = add_(totalSupplies, mintAmount);\n \n-            require(nextTotalSupplies < supplyCap, \"market supply cap reached\");\n+            // tTokens = underlyingTokens / exchangeRate\n \n+            uint totalSuppliesInUnderlyingToken = mul_(totalSupplies, Exp({mantissa: exchangeRateMantissa}));\n+\n+            uint nextTotalSuppliesInUnderlyingToken  = add_(totalSuppliesInUnderlyingToken, mintAmount);\n+            if (nextTotalSuppliesInUnderlyingToken > supplyCapInUnderlyingToken) {\n+                return uint(Error.MARKET_SUPPLY_CAP_REACHED);\n+            }\n         }\n \n         // Keep the flywheel moving\n         updateTonicSupplyIndex(tToken);\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:claimTonic(address)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT1:claimTonic(address).sol\n@@ -1,7 +1,5 @@\n-    function claimTonic(address holder, TToken[] memory tTokens) public {\n+    function claimTonic(address holder) public {\n \n-        address[] memory holders = new address[](1);\n+        return claimTonic(holder, allMarkets);\n \n-        holders[0] = holder;\n-        claimTonic(holders, tTokens, true, true);\n     }\n\\ No newline at end of file\n","Index: \n===================================================================\n--- \tTectonicCoreT1:claimTonic(address)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT5:claimTonic(address).sol\n@@ -1,5 +1,18 @@\n-    function claimTonic(address holder) public {\n+    function claimTonic(address holder, TToken[] memory tTokens) public {\n \n-        return claimTonic(holder, allMarkets);\n+        updateTonicAccruedForUser(holder, tTokens);\n \n+\n+        if (claimTokenHelper == address(0)) {\n+            // default path\n+            tonicAccrued[holder] = grantTonicInternal(holder, tonicAccrued[holder]);\n+        } else {\n+            // temporarily claim TONIC to claimTokenHelper\n+            tonicAccrued[holder] = grantTonicInternal(claimTokenHelper, tonicAccrued[holder]);\n+\n+            // @dev if the request comes from contract ClaimTokenHelper, we dont have to call it back\n+            if(msg.sender != claimTokenHelper) {\n+                ClaimTokenHelperInterface(claimTokenHelper).tonicDelayedEmissions(holder);\n+            }\n+        }\n     }\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:_setMintPaused(bool)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT5:_setMintPaused(bool).sol\n@@ -1,11 +1,8 @@\n     function _setMintPaused(TToken tToken, bool state) public returns (bool) {\n-        require(markets[address(tToken)].isListed, \"cannot pause a market that is not listed\");\n+        _pausedCheckEnhance(tToken, state);\n \n-        require(msg.sender == pauseGuardian || msg.sender == admin, \"only pause guardian and admin can pause\");\n \n-        require(msg.sender == admin || state == true, \"only admin can unpause\");\n-\n         mintGuardianPaused[address(tToken)] = state;\n         emit ActionPaused(tToken, \"Mint\", state);\n         return state;\n     }\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:_setBorrowPaused(bool)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT5:_setBorrowPaused(bool).sol\n@@ -1,11 +1,8 @@\n     function _setBorrowPaused(TToken tToken, bool state) public returns (bool) {\n-        require(markets[address(tToken)].isListed, \"cannot pause a market that is not listed\");\n+        _pausedCheckEnhance(tToken, state);\n \n-        require(msg.sender == pauseGuardian || msg.sender == admin, \"only pause guardian and admin can pause\");\n \n-        require(msg.sender == admin || state == true, \"only admin can unpause\");\n-\n         borrowGuardianPaused[address(tToken)] = state;\n         emit ActionPaused(tToken, \"Borrow\", state);\n         return state;\n     }\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:_setTransferPaused(bool)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT5:_setTransferPaused(bool).sol\n@@ -1,10 +1,8 @@\n     function _setTransferPaused(bool state) public returns (bool) {\n-        require(msg.sender == pauseGuardian || msg.sender == admin, \"only pause guardian and admin can pause\");\n+        _pausedCheck(state);\n \n-        require(msg.sender == admin || state == true, \"only admin can unpause\");\n \n-\n         transferGuardianPaused = state;\n         emit ActionPaused(\"Transfer\", state);\n         return state;\n     }\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:_setSeizePaused(bool)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT5:_setSeizePaused(bool).sol\n@@ -1,10 +1,8 @@\n     function _setSeizePaused(bool state) public returns (bool) {\n-        require(msg.sender == pauseGuardian || msg.sender == admin, \"only pause guardian and admin can pause\");\n+        _pausedCheck(state);\n \n-        require(msg.sender == admin || state == true, \"only admin can unpause\");\n \n-\n         seizeGuardianPaused = state;\n         emit ActionPaused(\"Seize\", state);\n         return state;\n     }\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:_become()/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT4:_become().sol\n@@ -1,4 +1,7 @@\n     function _become(TectonicSocket unitroller) public {\n         require(msg.sender == unitroller.admin(), \"only unitroller admin can change brains\");\n         require(unitroller._acceptImplementation() == 0, \"change not authorized\");\n+\n+        // TODO(warren.pan): Remove this post upgrade in TectonicCoreT5 by overriding _become()\n+        TectonicCoreT4(address(unitroller))._upgradeSplitTonicRewards();\n     }\n\\ No newline at end of file\n","Index: \n===================================================================\n--- \tTectonicCoreT4:_become()/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT5:_become().sol\n@@ -1,7 +1,4 @@\n     function _become(TectonicSocket unitroller) public {\n         require(msg.sender == unitroller.admin(), \"only unitroller admin can change brains\");\n         require(unitroller._acceptImplementation() == 0, \"change not authorized\");\n-\n-        // TODO(warren.pan): Remove this post upgrade in TectonicCoreT5 by overriding _become()\n-        TectonicCoreT4(address(unitroller))._upgradeSplitTonicRewards();\n     }\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:claimTonic(address[],bool,bool)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT5:claimTonic(address[],bool,bool).sol\n@@ -1,22 +1,1 @@\n-    function claimTonic(address[] memory holders, TToken[] memory tTokens, bool borrowers, bool suppliers) public {\n-        for (uint i = 0; i < tTokens.length; i++) {\n-            TToken tToken = tTokens[i];\n-            require(markets[address(tToken)].isListed, \"market must be listed\");\n-            if (borrowers == true) {\n-                Exp memory borrowIndex = Exp({mantissa: tToken.borrowIndex()});\n-                updateTonicBorrowIndex(address(tToken), borrowIndex);\n-                for (uint j = 0; j < holders.length; j++) {\n-                    distributeBorrowerTonic(address(tToken), holders[j], borrowIndex);\n-                }\n-            }\n-            if (suppliers == true) {\n-                updateTonicSupplyIndex(address(tToken));\n-                for (uint j = 0; j < holders.length; j++) {\n-                    distributeSupplierTonic(address(tToken), holders[j]);\n-                }\n-            }\n-        }\n-        for (uint j = 0; j < holders.length; j++) {\n-            tonicAccrued[holders[j]] = grantTonicInternal(holders[j], tonicAccrued[holders[j]]);\n-        }\n-    }\n\\ No newline at end of file\n+    function claimTonic(address[] memory holders, TToken[] memory tTokens, bool borrowers, bool suppliers) public {}\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:_grantTonic(address,uint)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT5:_grantTonic(address,uint).sol\n@@ -1,6 +1,1 @@\n-    function _grantTonic(address recipient, uint amount) public {\n-        require(adminOrInitializing(), \"only admin can grant tonic\");\n-        uint amountLeft = grantTonicInternal(recipient, amount);\n-        require(amountLeft == 0, \"insufficient tonic for grant\");\n-        emit TonicGranted(recipient, amount);\n-    }\n\\ No newline at end of file\n+    function _grantTonic(address recipient, uint amount) public {}\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT4:_upgradeSplitTonicRewards()/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT5:_upgradeSplitTonicRewards().sol\n@@ -1,29 +1,1 @@\n-    function _upgradeSplitTonicRewards() public {\n-        require(msg.sender == tectonicCoreImplementation, \"only brains can become itself\");\n-\n-        uint32 blockNumber = safe32(getBlockNumber(), \"block number exceeds 32 bits\");\n-\n-        // tonicSpeeds -> tonicBorrowSpeeds & tonicSupplySpeeds t\n-        for (uint i = 0; i < allMarkets.length; i ++) {\n-            tonicBorrowSpeeds[address(allMarkets[i])] = tonicSupplySpeeds[address(allMarkets[i])] = tonicSpeeds[address(allMarkets[i])];\n-            delete tonicSpeeds[address(allMarkets[i])];\n-\n-            /*\n-             * Ensure supply and borrow state indices are all set. If not set, update to default value\n-             */\n-            TonicMarketState storage supplyState = tonicSupplyState[address(allMarkets[i])];\n-            TonicMarketState storage borrowState = tonicBorrowState[address(allMarkets[i])];\n-\n-            if (supplyState.index == 0) {\n-                // Initialize supply state index with default value\n-                supplyState.index = tonicInitialIndex;\n-                supplyState.block = blockNumber;\n-            }\n-\n-            if (borrowState.index == 0) {\n-                // Initialize borrow state index with default value\n-                borrowState.index = tonicInitialIndex;\n-                borrowState.block = blockNumber;\n-            }\n-        }\n-    }\n\\ No newline at end of file\n+    function _upgradeSplitTonicRewards() public {}\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:_supportMarket()/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT4:_supportMarket().sol\n@@ -12,9 +12,11 @@\n         // Note that isTonicized is not in active use anymore\n         markets[address(tToken)] = Market({isListed: true, isTonicized: false, collateralFactorMantissa: 0});\n \n         _addMarketInternal(address(tToken));\n+        _initializeMarket(address(tToken));\n \n+\n         emit MarketListed(tToken);\n \n         return uint(Error.NO_ERROR);\n     }\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:updateTonicSupplyIndex(address)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT4:updateTonicSupplyIndex(address).sol\n@@ -1,24 +1,21 @@\n     function updateTonicSupplyIndex(address tToken) internal {\n         TonicMarketState storage supplyState = tonicSupplyState[tToken];\n-        uint supplySpeed = tonicSpeeds[tToken];\n+        uint supplySpeed = tonicSupplySpeeds[tToken];\n \n-        uint blockNumber = getBlockNumber();\n+        uint32 blockNumber = safe32(getBlockNumber(), \"block number exceeds 32 bits\");\n \n-        uint deltaBlocks = sub_(blockNumber, uint(supplyState.block));\n+        uint deltaBlocks = sub_(uint(blockNumber), uint(supplyState.block));\n \n         if (deltaBlocks > 0 && supplySpeed > 0) {\n             uint supplyTokens = TToken(tToken).totalSupply();\n             uint tonicAccrued = mul_(deltaBlocks, supplySpeed);\n             Double memory ratio = supplyTokens > 0 ? fraction(tonicAccrued, supplyTokens) : Double({mantissa: 0});\n-            Double memory index = add_(Double({mantissa: supplyState.index}), ratio);\n+            supplyState.index = safe224(add_(Double({mantissa: supplyState.index}), ratio).mantissa, \"new index exceeds 224 bits\");\n \n-            tonicSupplyState[tToken] = TonicMarketState({\n+            supplyState.block = blockNumber;\n \n-                index: safe224(index.mantissa, \"new index exceeds 224 bits\"),\n-                block: safe32(blockNumber, \"block number exceeds 32 bits\")\n-            });\n         } else if (deltaBlocks > 0) {\n-            supplyState.block = safe32(blockNumber, \"block number exceeds 32 bits\");\n+            supplyState.block = blockNumber;\n \n         }\n     }\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:updateTonicBorrowIndex(address)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT4:updateTonicBorrowIndex(address).sol\n@@ -1,24 +1,21 @@\n     function updateTonicBorrowIndex(address tToken, Exp memory marketBorrowIndex) internal {\n         TonicMarketState storage borrowState = tonicBorrowState[tToken];\n-        uint borrowSpeed = tonicSpeeds[tToken];\n+        uint borrowSpeed = tonicBorrowSpeeds[tToken];\n \n-        uint blockNumber = getBlockNumber();\n+        uint32 blockNumber = safe32(getBlockNumber(), \"block number exceeds 32 bits\");\n \n-        uint deltaBlocks = sub_(blockNumber, uint(borrowState.block));\n+        uint deltaBlocks = sub_(uint(blockNumber), uint(borrowState.block));\n \n         if (deltaBlocks > 0 && borrowSpeed > 0) {\n             uint borrowAmount = div_(TToken(tToken).totalBorrows(), marketBorrowIndex);\n             uint tonicAccrued = mul_(deltaBlocks, borrowSpeed);\n             Double memory ratio = borrowAmount > 0 ? fraction(tonicAccrued, borrowAmount) : Double({mantissa: 0});\n-            Double memory index = add_(Double({mantissa: borrowState.index}), ratio);\n+            borrowState.index = safe224(add_(Double({mantissa: borrowState.index}), ratio).mantissa, \"new index exceeds 224 bits\");\n \n-            tonicBorrowState[tToken] = TonicMarketState({\n+            borrowState.block = blockNumber;\n \n-                index: safe224(index.mantissa, \"new index exceeds 224 bits\"),\n-                block: safe32(blockNumber, \"block number exceeds 32 bits\")\n-            });\n         } else if (deltaBlocks > 0) {\n-            borrowState.block = safe32(blockNumber, \"block number exceeds 32 bits\");\n+            borrowState.block = blockNumber;\n \n         }\n     }\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:distributeSupplierTonic(address,address)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT4:distributeSupplierTonic(address,address).sol\n@@ -1,24 +1,34 @@\n     function distributeSupplierTonic(address tToken, address supplier) internal {\n+        // TODO: Don't distribute supplier TONIC if the user is not in the supplier market.\n+        // This check should be as gas efficient as possible as distributeSupplierTonic is called in many places.\n+        // - We really don't want to call an external contract as that's quite expensive.\n+\n         TonicMarketState storage supplyState = tonicSupplyState[tToken];\n-        Double memory supplyIndex = Double({mantissa: supplyState.index});\n+        uint supplyIndex = supplyState.index;\n \n-        Double memory supplierIndex = Double({mantissa: tonicSupplierIndex[tToken][supplier]});\n+        uint supplierIndex = tonicSupplierIndex[tToken][supplier];\n \n-        tonicSupplierIndex[tToken][supplier] = supplyIndex.mantissa;\n \n+        // Update supplier's index to the current index since we are distributing accrued TONIC\n \n-        if (supplierIndex.mantissa == 0 && supplyIndex.mantissa > 0) {\n+        tonicSupplierIndex[tToken][supplier] = supplyIndex;\n \n-            supplierIndex.mantissa = tonicInitialIndex;\n \n+        if (supplierIndex == 0 && supplyIndex >= tonicInitialIndex) {\n+            // Covers the case where users supplied tokens before the market's supply state index was set.\n+            // Rewards the user with TONIC accrued from the start of when supplier rewards were first\n+            // set for the market.\n+            supplierIndex = tonicInitialIndex;\n         }\n \n-        Double memory deltaIndex = sub_(supplyIndex, supplierIndex);\n+        // Calculate change in the cumulative sum of the TONIC per borrowed unit accrued\n \n+        Double memory deltaIndex = Double({mantissa: sub_(supplyIndex, supplierIndex)});\n         uint supplierTokens = TToken(tToken).balanceOf(supplier);\n+        // Calculate TONIC accrued: tTokenAmount * accruedPerTToken\n         uint supplierDelta = mul_(supplierTokens, deltaIndex);\n         uint supplierAccrued = add_(tonicAccrued[supplier], supplierDelta);\n         tonicAccrued[supplier] = supplierAccrued;\n-        emit DistributedSupplierTonic(TToken(tToken), supplier, supplierDelta, supplyIndex.mantissa);\n \n+        emit DistributedSupplierTonic(TToken(tToken), supplier, supplierDelta, supplyIndex);\n     }\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:distributeBorrowerTonic(address,address)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT4:distributeBorrowerTonic(address,address).sol\n@@ -1,25 +1,38 @@\n     function distributeBorrowerTonic(address tToken, address borrower, Exp memory marketBorrowIndex) internal {\n+        // TODO: Don't distribute supplier TONIC if the user is not in the borrower market.\n+        // This check should be as gas efficient as possible as distributeBorrowerTonic is called in many places.\n+        // - We really don't want to call an external contract as that's quite expensive.\n         TonicMarketState storage borrowState = tonicBorrowState[tToken];\n-        Double memory borrowIndex = Double({mantissa: borrowState.index});\n+        uint borrowIndex = borrowState.index;\n \n-        Double memory borrowerIndex = Double({mantissa: tonicBorrowerIndex[tToken][borrower]});\n+        uint borrowerIndex = tonicBorrowerIndex[tToken][borrower];\n \n-        tonicBorrowerIndex[tToken][borrower] = borrowIndex.mantissa;\n \n+        // Update borrower's index to the current index since we are distributing accrued TONIC\n \n-        if (borrowerIndex.mantissa > 0) {\n+        tonicBorrowerIndex[tToken][borrower] = borrowIndex;\n \n-            Double memory deltaIndex = sub_(borrowIndex, borrowerIndex);\n \n-            uint borrowerAmount = div_(TToken(tToken).borrowBalanceStored(borrower), marketBorrowIndex);\n \n-            uint borrowerDelta = mul_(borrowerAmount, deltaIndex);\n+        if (borrowerIndex == 0 && borrowIndex >= tonicInitialIndex) {\n \n-            uint borrowerAccrued = add_(tonicAccrued[borrower], borrowerDelta);\n+            // Covers the case where users borrowed tokens before the market's borrow state index was set.\n \n-            tonicAccrued[borrower] = borrowerAccrued;\n+            // Rewards the user with TONIC accrued from the start of when borrower rewards were first\n \n-            emit DistributedBorrowerTonic(TToken(tToken), borrower, borrowerDelta, borrowIndex.mantissa);\n+            // set for the market.\n \n+            borrowerIndex = tonicInitialIndex;\n         }\n+\n+        // Calculate change in the cumulative sum of the TONIC per borrowed unit accrued\n+        Double memory deltaIndex = Double({mantissa: sub_(borrowIndex, borrowerIndex)});\n+\n+        uint borrowerAmount = div_(TToken(tToken).borrowBalanceStored(borrower), marketBorrowIndex);\n+        // Calculate TONIC accrued: tTokenAmount * accruedPerTToken\n+        uint borrowerDelta = mul_(borrowerAmount, deltaIndex);\n+        uint borrowerAccrued = add_(tonicAccrued[borrower], borrowerDelta);\n+        tonicAccrued[borrower] = borrowerAccrued;\n+\n+        emit DistributedBorrowerTonic(TToken(tToken), borrower, borrowerDelta, borrowIndex);\n     }\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:setTonicSpeedInternal(uint)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT4:setTonicSpeedInternal(uint).sol\n@@ -1,38 +1,1 @@\n-    function setTonicSpeedInternal(TToken tToken, uint tonicSpeed) internal {\n-        uint currentTonicSpeed = tonicSpeeds[address(tToken)];\n-        if (currentTonicSpeed != 0) {\n-            // note that TONIC speed could be set to 0 to halt liquidity rewards for a market\n-            Exp memory borrowIndex = Exp({mantissa: tToken.borrowIndex()});\n-            updateTonicSupplyIndex(address(tToken));\n-            updateTonicBorrowIndex(address(tToken), borrowIndex);\n-        } else if (tonicSpeed != 0) {\n-            // Add the TONIC market\n-            Market storage market = markets[address(tToken)];\n-            require(market.isListed == true, \"tonic market is not listed\");\n-\n-            if (tonicSupplyState[address(tToken)].index == 0) {\n-                tonicSupplyState[address(tToken)] = TonicMarketState({\n-                    index: tonicInitialIndex,\n-                    block: safe32(getBlockNumber(), \"block number exceeds 32 bits\")\n-                });\n-            } else {\n-                // Update block number to ensure extra interest is not accrued during the prior period\n-                tonicSupplyState[address(tToken)].block = safe32(getBlockNumber(), \"block number exceeds 32 bits\");\n-            }\n-\n-            if (tonicBorrowState[address(tToken)].index == 0) {\n-                tonicBorrowState[address(tToken)] = TonicMarketState({\n-                    index: tonicInitialIndex,\n-                    block: safe32(getBlockNumber(), \"block number exceeds 32 bits\")\n-                });\n-            } else {\n-                // Update block number to ensure extra interest is not accrued during the prior period\n-                tonicBorrowState[address(tToken)].block = safe32(getBlockNumber(), \"block number exceeds 32 bits\");\n-            }\n-        }\n-\n-        if (currentTonicSpeed != tonicSpeed) {\n-            tonicSpeeds[address(tToken)] = tonicSpeed;\n-            emit TonicSpeedUpdated(tToken, tonicSpeed);\n-        }\n-    }\n\\ No newline at end of file\n+    function setTonicSpeedInternal(TToken tToken, uint tonicSpeed) internal {}\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:_setTonicSpeed(uint)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT4:_setTonicSpeed(uint).sol\n@@ -1,4 +1,1 @@\n-    function _setTonicSpeed(TToken tToken, uint tonicSpeed) public {\n-        require(adminOrInitializing(), \"only admin can set tonic speed\");\n-        setTonicSpeedInternal(tToken, tonicSpeed);\n-    }\n\\ No newline at end of file\n+    function _setTonicSpeed(TToken tToken, uint tonicSpeed) public {}\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:_setContributorTonicSpeed(address,uint)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT4:_setContributorTonicSpeed(address,uint).sol\n@@ -1,15 +1,1 @@\n-    function _setContributorTonicSpeed(address contributor, uint tonicSpeed) public {\n-        require(adminOrInitializing(), \"only admin can set tonic speed\");\n-\n-        // note that TONIC speed could be set to 0 to halt liquidity rewards for a contributor\n-        updateContributorRewards(contributor);\n-        if (tonicSpeed == 0) {\n-            // release storage\n-            delete lastContributorBlock[contributor];\n-        } else {\n-            lastContributorBlock[contributor] = getBlockNumber();\n-        }\n-        tonicContributorSpeeds[contributor] = tonicSpeed;\n-\n-        emit ContributorTonicSpeedUpdated(contributor, tonicSpeed);\n-    }\n\\ No newline at end of file\n+    function _setContributorTonicSpeed(address contributor, uint tonicSpeed) public {}\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:updateContributorRewards(address)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT4:updateContributorRewards(address).sol\n@@ -1,12 +1,1 @@\n-    function updateContributorRewards(address contributor) public {\n-        uint tonicSpeed = tonicContributorSpeeds[contributor];\n-        uint blockNumber = getBlockNumber();\n-        uint deltaBlocks = sub_(blockNumber, lastContributorBlock[contributor]);\n-        if (deltaBlocks > 0 && tonicSpeed > 0) {\n-            uint newAccrued = mul_(deltaBlocks, tonicSpeed);\n-            uint contributorAccrued = add_(tonicAccrued[contributor], newAccrued);\n-\n-            tonicAccrued[contributor] = contributorAccrued;\n-            lastContributorBlock[contributor] = blockNumber;\n-        }\n-    }\n\\ No newline at end of file\n+    function updateContributorRewards(address contributor) public {}\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:_setWhitelistProtect(bool)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT3:_setWhitelistProtect(bool).sol\n@@ -1,5 +1,1 @@\n-    function _setWhitelistProtect(bool whitelistStatus) public {\n-        require(adminOrInitializing(), \"only admin can change whitelist\");\n-        whitelistProtectEnabled = whitelistStatus;\n-        emit WhitelistStatusChanged(whitelistStatus);\n-    }\n\\ No newline at end of file\n+    function _setWhitelistProtect(bool whitelistStatus) public {}\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:_addToWhitelistProtect(address[])/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT3:_addToWhitelistProtect(address[]).sol\n@@ -1,8 +1,1 @@\n-    function _addToWhitelistProtect(address[] memory accounts) public {\n-        require(adminOrInitializing(), \"only admin can change whitelist\");\n-\n-        uint numAccount = accounts.length;\n-        for (uint i = 0; i < numAccount; i++) {\n-            _addToWhitelistProtectSingle(accounts[i]);\n-        }\n-    }\n\\ No newline at end of file\n+    function _addToWhitelistProtect(address[] memory accounts) public {}\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:_addToWhitelistProtectSingle(address)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT3:_addToWhitelistProtectSingle(address).sol\n@@ -1,4 +1,1 @@\n-    function _addToWhitelistProtectSingle(address account) internal {\n-        whitelistedAddresses[account] = true;\n-        emit WhitelistAccountAdded(account);\n-    }\n\\ No newline at end of file\n+    function _addToWhitelistProtectSingle(address account) internal {}\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:_removeFromWhitelistProtect(address)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT3:_removeFromWhitelistProtect(address).sol\n@@ -1,5 +1,1 @@\n-    function _removeFromWhitelistProtect(address account) public {\n-        require(adminOrInitializing(), \"only admin can change whitelist\");\n-        whitelistedAddresses[account] = false;\n-        emit WhitelistAccountRemoved(account);\n-    }\n\\ No newline at end of file\n+    function _removeFromWhitelistProtect(address account) public {}\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:_updateTvlProtectLimit(uint[])/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT3:_updateTvlProtectLimit(uint[]).sol\n@@ -1,8 +1,1 @@\n-    function _updateTvlProtectLimit(TToken[] memory tTokens, uint[] memory newLimitPerUser) public {\n-        require(adminOrInitializing(), \"only admin can change TVL protect limit\");\n-        require(tTokens.length == newLimitPerUser.length, \"Tokens and newLimitPerUser array length must be equal\");\n-        for (uint i = 0; i < tTokens.length; i++) {\n-            tokenToPerUserTvlProtectLimit[address(tTokens[i])] = newLimitPerUser[i];\n-            emit TVLProtectLimitUpdated(tTokens[i], newLimitPerUser[i]);\n-        }\n-    }\n\\ No newline at end of file\n+    function _updateTvlProtectLimit(TToken[] memory tTokens, uint[] memory newLimitPerUser) public {}\n\\ No newline at end of file\n"],["Index: \n===================================================================\n--- \tTectonicCoreT1:liquidateCalculateSeizeTokens(address,address,uint)/Users/junjiefei/Projects/repos/auditor-notebook/src/client-portrait/display.sol\n+++ \tTectonicCoreT2:liquidateCalculateSeizeTokens(address,address,uint).sol\n@@ -17,14 +17,14 @@\n         Exp memory numerator;\n         Exp memory denominator;\n         Exp memory ratio;\n \n-        numerator = mul_(Exp({mantissa: liquidationIncentiveMantissa}), Exp({mantissa: priceBorrowedMantissa}));\n+        numerator = mul_(mul_(Exp({mantissa: liquidationIncentiveMantissa}), Exp({mantissa: priceBorrowedMantissa})), actualRepayAmount);\n \n         denominator = mul_(Exp({mantissa: priceCollateralMantissa}), Exp({mantissa: exchangeRateMantissa}));\n         ratio = div_(numerator, denominator);\n \n-        seizeTokens = mul_ScalarTruncate(ratio, actualRepayAmount);\n+        seizeTokens = truncate(ratio);\n \n \n         return (uint(Error.NO_ERROR), seizeTokens);\n     }\n\\ No newline at end of file\n"]]
  
  window.addEventListener('DOMContentLoaded', (event) => {
      
      diffObjs.forEach((diffStrings, diffIndex) => {
          const titleElement = document.createElement('h2');
          titleElement.textContent = titles[diffIndex]; 
          titleElement.style.cssText = "color: navy;";
          document.body.appendChild(titleElement);
    
          diffStrings.forEach((diffString, stringIndex) => {
              const diffElement = document.createElement('div');
              diffElement.id = `diffElement${diffIndex}_${stringIndex}`;
              document.body.appendChild(diffElement);

              const configuration = {
                  drawFileList: false,
                  fileListToggle: false,
                  fileListStartVisible: false,
                  stickyFileHeaders: false,
                  fileContentToggle: true,
                  matching: 'words',
                  diffStyle: 'char',
                  outputFormat: 'side-by-side',
                  synchronisedScroll: true,
                  renderNothingWhenEmpty: false,
              };

              const diff2htmlUi = new Diff2HtmlUI(diffElement, diffString, configuration, hljs);
              diff2htmlUi.draw();
              
              diff2htmlUi.hljs.registerLanguage("solidity", window.solidity);
              diff2htmlUi.hljs.highlightAll();
              
              diff2htmlUi.highlightCode();
          });
          if (diffIndex < diffObjs.length - 1) {
            const separator = document.createElement('hr');
            separator.style.cssText = "height:2px;border-width:0;color:gray;background-color:gray";
            document.body.appendChild(separator);
        }
      });
  });
  </script>
  
  <body>
    <div id="myDiffElement"></div>
  </body>
</html>
